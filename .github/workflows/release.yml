name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-15

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_26.0.1.app/Contents/Developer

    - name: Build release binaries
      run: swift build -c release --disable-sandbox

    - name: Create archive
      run: |
        mkdir -p dist
        cp .build/release/xc-mcp dist/
        cp .build/release/xc-project dist/
        cp .build/release/xc-simulator dist/
        cp .build/release/xc-device dist/
        cp .build/release/xc-debug dist/
        cp .build/release/xc-swift dist/
        cp .build/release/xc-build dist/
        cp .build/release/xc-strings dist/
        cd dist && tar -czvf ../xc-mcp-${{ github.ref_name }}-arm64.tar.gz *

    - name: Generate SHA256
      run: shasum -a 256 xc-mcp-${{ github.ref_name }}-arm64.tar.gz > xc-mcp-${{ github.ref_name }}-arm64.tar.gz.sha256

    - name: Generate release notes
      id: release_notes
      run: |
        # Get the previous tag
        PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')
        if [ -z "$PREV_TAG" ]; then
          # First release, get all commits
          NOTES=$(git log --pretty=format:"- %s" HEAD)
        else
          # Get commits since previous tag
          NOTES=$(git log --pretty=format:"- %s" ${PREV_TAG}..HEAD)
        fi
        # Write to file to preserve newlines
        echo "$NOTES" > release_notes.txt

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          xc-mcp-${{ github.ref_name }}-arm64.tar.gz
          xc-mcp-${{ github.ref_name }}-arm64.tar.gz.sha256
        body_path: release_notes.txt
