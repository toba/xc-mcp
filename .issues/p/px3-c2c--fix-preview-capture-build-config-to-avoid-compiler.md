---
# px3-c2c
title: Fix preview_capture build config to avoid compiler crash and launch failure
status: in-progress
type: bug
priority: high
created_at: 2026-02-17T02:40:18Z
updated_at: 2026-02-17T04:59:03Z
---

The preview_capture tool builds a temporary preview host app from a target project's source. Finding a build configuration that both compiles and launches successfully has been difficult.

## Problem

Two independent failure modes constrain the build configuration:

1. **Release config** → linker error: `Undefined symbol '_relinkableLibraryClasses'` (from ld 1230.1, Xcode 26). Symbol is embedded in the linker binary itself, generated unconditionally, not provided by any SDK/runtime/framework. No build setting suppresses it.

2. **Debug config** → `.debug.dylib` generated by Swift incremental compilation. This dylib references `_$s4Core10DiagnosticCN` (Core.Diagnostic class metadata) but can't resolve it at launch time. Crash: "Symbol not found, Referenced from .debug.dylib, Expected in .debug.dylib".

## Complete Attempt Log

### Release Config Variants
1. [x] Release + GCC_OPTIMIZATION_LEVEL=0 → Swift compiler crash (ASTMangler infinite recursion)
2. [x] Release (default -O) → `Undefined symbol '_relinkableLibraryClasses'`
3. [x] Release + SWIFT_OPTIMIZATION_LEVEL=-Osize → Same linker error
4. [x] Release + SWIFT_OPTIMIZATION_LEVEL=-Onone → Build ok, .debug.dylib crash (compiler generates debug dylibs with -Onone)
5. [x] Release + -Onone + SWIFT_COMPILATION_MODE=wholemodule → Still generates .debug.dylib
6. [x] Release + -O + OTHER_LDFLAGS=-Wl,-U,_relinkableLibraryClasses (cmd-line override) → Clobbered existing flags, same error
7. [x] Release + -O + OTHER_LDFLAGS in preview host target build settings (via XcodeProj) → Error from dependency target, not preview host
8. [x] Release + -O + xcconfig with OTHER_LDFLAGS=$(inherited) -Wl,-U,... → Flag not appearing in linker args
9. [x] Release + SWIFT_ENABLE_LIBRARY_EVOLUTION=NO → Still same linker error
10. [x] Release + ENABLE_THREAD/UNDEFINED_BEHAVIOR/ADDRESS_SANITIZER=NO → Still same linker error (clean DerivedData)

### Debug Config Variants
11. [x] Debug config → .debug.dylib references Core.Diagnostic → launch crash
12. [x] Release + -Onone (effectively Debug optimization) → Same .debug.dylib crash
13. [x] Debug + SWIFT_SERIALIZE_DEBUGGING_OPTIONS=NO → Module dependency errors (stale DerivedData)
14. [x] Debug + SWIFT_USE_INTEGRATED_DRIVER=NO → Legacy driver errors (can't read @response files)
15. [x] Plain Debug (clean DerivedData, warm caches) → .debug.dylib crash (same Symbol not found)

### Post-Build Patching
16. [x] Delete .debug.dylib from app bundle → "Library not loaded" (binary has hard @rpath link)
17. [x] install_name_tool -change + codesign binary → "unsealed contents in bundle root"
18. [x] install_name_tool -change + codesign --deep app bundle → Same unsealed contents error
19. [x] Launch binary directly with DYLD_FRAMEWORK_PATH (bypass LaunchServices, help .debug.dylib resolve symbols)\n20. [x] Apply build-review skill config: ENABLE_DEBUG_DYLIB=NO + MERGED_BINARY_TYPE=none + SKIP_MERGEABLE_LIBRARY_BUNDLE_HOOK=YES + SWIFT_COMPILATION_MODE=wholemodule + SWIFT_OPTIMIZATION_LEVEL=-Onone ← CURRENT (needs end-to-end test)

## Key Facts
- ld version: 1230.1 (Xcode 26, Dec 2 2025)
- _relinkableLibraryClasses: exists ONLY as strings in the ld binary, not in any SDK/runtime/framework. No disable flag found.
- .debug.dylib: generated by Swift incremental compilation for preview/debug support. References dependency framework symbols.
- Test: Thesis project, DOM scheme, TestPreview.swift
- xc-mcp base-path: positional arg (not --base-path)
- Crash reports: ~/Library/Logs/DiagnosticReports/_PreviewHost_*.ips
- ENABLE_PREVIEWS=NO and stripPreviewBlocks already in use

## Current Approach
Trying to launch the preview host binary directly (not via `open -a`) with `DYLD_FRAMEWORK_PATH` pointing to build products. This lets the .debug.dylib find Core.framework at runtime. `open -a` strips environment variables, so direct launch is needed.


## Session 3 Findings (2026-02-16)

### Attempt 20: Test DYLD_FRAMEWORK_PATH approach

**Result**: Could not reach the .debug.dylib crash — a **different** build-time failure blocks progress.

### New Bug: SPM transitive dependency linking fails for app targets

When the preview host target is injected for a file belonging to an **app target** (e.g., the Standard/Thesis target), the `collectTransitiveDependencies` function collects native framework targets (Core, DOM, Zotero, DocX, etc.) and the SPM package dependency collection iterates those targets' `packageProductDependencies`. However, the linker fails with undefined symbols for:

- **HTTPTypes** (used by Zotero framework)
- **ZIPFoundation** (used by DocX framework)

Linker warnings also show:
- `ignoring missing indirect library: library for install name '@rpath/Zotero.framework'`
- `ignoring missing indirect library: library for install name '@rpath/DocX.framework'`

This suggests the transitive SPM packages (HTTPTypes, ZIPFoundation) aren't being linked into the preview host app, even though the code at lines 765-789 of PreviewCaptureTool.swift attempts to collect them.

### Framework target previews: access control blocks compilation

When targeting a framework module (e.g., DOM), the preview host does `import DOM` and uses the type directly. But most views in the Thesis project are `internal` (not `public`), so compilation fails with "cannot find 'ViewName' in scope".

### App target previews: only single file compiled

For app targets, only the source file (with #Preview stripped) is added to the preview host. Other files from the same app target are NOT included, so any cross-file references fail to compile. A trivial `Text("Hello")` preview compiles but fails at link time due to the SPM issue above.

### Test infrastructure issues

- `echo >> fifo` closes the write end, causing EOF → server shutdown. Must use a persistent subshell writer with `sleep` to keep fifo open.
- `PreviewTest.swift` copied to `App/Sources/` wasn't in any Xcode target, but the tool still matched it to the app target via directory heuristics.
- File paths in Thesis project: Core at `Core/Sources/`, DOM at `DOM/Sources/`, App at `App/Sources/`.

### Updated status

The .debug.dylib DYLD_FRAMEWORK_PATH fix remains **UNTESTED** because the build doesn't succeed on macOS for this project. The build failures are a pre-existing issue with SPM transitive dependency handling, not caused by the Debug/Release config changes.

### Possible paths forward

1. Fix SPM transitive dependency collection in injectTarget() so HTTPTypes/ZIPFoundation get linked
2. Test with a simpler project that doesn't have deep SPM dependency chains
3. Test iOS Simulator path (already confirmed working per commit 396e714) to verify no regressions
4. Consider whether the DYLD_FRAMEWORK_PATH approach even works (SIP may strip DYLD_* for signed binaries)


## Session 3 Continued — Deep Dive into SPM Transitive Deps

### Root Cause: Mergeable Libraries (Xcode 15+)

Frameworks Zotero and DocX produce **empty framework bundles** (no dylib binary). Their build products contain only `Modules/` and `Resources/` dirs. Investigation revealed:

- All 11 framework targets have `MERGEABLE_LIBRARY = YES`, `MACH_O_TYPE = mh_dylib`
- But Zotero and DocX produce no binary while Core, DOM, CSL, Ghost, Obsidian, etc. DO produce dylibs
- The differentiator is still unclear — all have the same build settings

### Framework binary status (DerivedData/Build/Products/Debug/)
| Framework | Has Binary | Frameworks Build Phase |
|-----------|-----------|----------------------|
| Core | YES (dylib) | YES (links HTTPTypes, GRDB, etc.) |
| DOM | YES (dylib) | Unknown |
| CSL | YES (dylib) | Unknown |
| Ghost | YES (dylib) | YES |
| Obsidian | YES (dylib) | Unknown |
| BibTeX | YES (dylib) | Unknown |
| RIS | YES (dylib) | Unknown |
| EndNote | YES (dylib) | Unknown |
| GRDBQuery | YES (dylib) | Unknown |
| **Zotero** | **NO** | NO (only Headers + Sources) |
| **DocX** | **NO** | NO (only Headers + Sources) |

### Dependency collection works correctly
Debug logging confirms:
- `sourceTarget: ThesisApp (isApp=true), frameworkDeps: [all 11 targets]`
- `Core SPM deps: ["HTTPTypes", "HTTPTypesFoundation", "ZIPFoundation"]`
- SPM deps are collected and added to preview host target
- `GRDBQuery` has `dep.target=nil` (uses targetProxy for cross-project GRDBCustom ref)

### Build setting overrides tried (all failed):
- `MERGED_BINARY_TYPE = "none"` on preview host target build settings — no effect on framework builds
- `MERGEABLE_LIBRARY=NO` as xcodebuild command-line override — Zotero/DocX still have no binary
- `MAKE_MERGEABLE=YES` as xcodebuild command-line override — Zotero/DocX still have no binary

The build settings are being applied (verified via `-showBuildSettings`) but the build system caches framework builds. Deleting the .framework dirs from Products isn't enough to force relinking; the intermediates (.o files) are still cached.

### Key finding: HTTPTypes is a static .o file, not a framework
- `HTTPTypes.o` and `HTTPTypesFoundation.o` exist as bare .o files in build products
- No `HTTPTypes.framework` in the top-level build products
- These are SPM packages built as static libraries
- They get linked into Core.framework (which does produce a dylib)
- But when the linker tries to merge Zotero's .o files into the preview host, it needs HTTPTypes symbols that aren't available

### Current state
The `MERGED_BINARY_TYPE = "none"` fix works for **framework targets** (DOM test: no linker errors, only access control failure). It does NOT work for **app targets** (ThesisApp) because Zotero/DocX produce empty bundles.

Next investigation: checking if the generated pbxproj properly writes the SPM package product dependencies, and whether the linker actually uses them.


## Research: Swift Source Code & Build System (2026-02-16)

### Key Finding: `ENABLE_DEBUG_DYLIB=NO`

Xcode 16+ introduced `ENABLE_DEBUG_DYLIB` (default YES), which puts all app code into a `.debug.dylib` and replaces the app executable with a trivial stub. This is the exact mechanism causing the Debug config crashes (attempt #11-15). **Setting `ENABLE_DEBUG_DYLIB=NO` on the preview host target should prevent `.debug.dylib` generation entirely.**

This was NOT tried in any of the 19 attempts. It directly addresses failure mode #2.

### Mergeable Libraries Insight

Empty framework bundles (Zotero, DocX) are **expected behavior** when mergeable libraries are active. The app target's `MERGED_BINARY_TYPE` causes dependent frameworks to be merged into the app binary, leaving empty stubs. The preview host target must either:
- Set `MERGED_BINARY_TYPE=none` on itself (already partially working per session 3)
- Set `MERGEABLE_LIBRARY=NO` on all framework dependencies

Debug builds do NOT merge (per Apple docs) — they still embed individual frameworks. So using Debug config + `ENABLE_DEBUG_DYLIB=NO` should give us real framework binaries.

### `_relinkableLibraryClasses` — Dead End

- Zero public references anywhere (GitHub, forums, docs, LLVM repo)
- Appears to be an internal Apple linker symbol in ld 1230.1 (Xcode 26)
- `ld_classic` (old linker fallback) was deprecated in Xcode 16 and **removed in Xcode 26**
- No known build setting or linker flag suppresses it
- Release config is a dead end for Xcode 26

### swift.org Source Code Repos Assessment

Reviewed all repos at swift.org/documentation/source-code/. The relevant components (Apple's linker, Xcode build system, mergeable libraries, preview host generation) are NOT in the open-source repos. The open-source swift repo contains compiler code but not the proprietary linker or build system. No actionable code found in:
- swiftlang/swift (compiler)
- swiftlang/swift-package-manager (SPM)
- swiftlang/llvm-project (LLVM, but not Apple's proprietary ld)

### Recommended Next Attempt

**Attempt 20**: Debug config + `ENABLE_DEBUG_DYLIB=NO` + `MERGED_BINARY_TYPE=none` on preview host
- Debug config gives us real framework binaries (no merging in Debug)
- `ENABLE_DEBUG_DYLIB=NO` prevents .debug.dylib generation and crash
- `MERGED_BINARY_TYPE=none` already shown to help per session 3
- This combination has NOT been tested yet


## Session 4 Findings (2026-02-16): swift-driver / Mergeable Libraries Research

### Root Cause: _relinkableLibraryClasses

This is NOT a swift-driver issue. It's a **mergeable libraries** feature from the Xcode 15+ linker. The `_relinkableLibraryClasses` symbol is synthetically generated during `-merge_framework` static merging — it maps ObjC classes to framework bundles for `Bundle(for:)` support. The Thesis project likely has `MERGED_BINARY_TYPE=automatic` on a target, which triggers framework merging in Release builds. When the preview host target doesn't participate properly, the linker expects the synthetic symbol but can't generate it.

**Fix**: Pass `MERGED_BINARY_TYPE=none` as a build setting override to disable mergeable library merging entirely.

Source: [kateinoigakukun/MergeableLibraryInternals](https://github.com/kateinoigakukun/MergeableLibraryInternals)

### Root Cause: .debug.dylib

Generated by Swift incremental compilation (`SWIFT_COMPILATION_MODE=incremental`, the Debug default). The `.debug.dylib` files contain recompiled code and reference dependency framework symbols that can't resolve at launch time.

**Fix**: Pass `SWIFT_COMPILATION_MODE=wholemodule` to suppress incremental artifact generation. With `-Onone` this preserves Debug semantics without producing .debug.dylib files.

### Recommended Build Config (UNTESTED)

```
-configuration Debug
MERGED_BINARY_TYPE=none
SWIFT_COMPILATION_MODE=wholemodule
SWIFT_OPTIMIZATION_LEVEL=-Onone
ENABLE_PREVIEWS=NO
ONLY_ACTIVE_ARCH=YES
```

This should avoid both failure modes: no mergeable library merging (no `_relinkableLibraryClasses`), and no incremental `.debug.dylib` generation.

### swift-driver Review

Nothing directly actionable from swiftlang/swift-driver for these issues. The driver controls incremental compilation scheduling but has no flag to suppress `.debug.dylib` independently. PR #1923 (file hashing for incremental builds) and PR #2033 (swiftmodule hashing) are about rebuild accuracy, not relevant here.


### Root Cause Identified: DerivedData Cache Contamination

Build settings for Zotero and CSL are **identical** (both have MERGEABLE_LIBRARY=YES, MACH_O_TYPE=mh_dylib, MAKE_MERGEABLE=NO). The difference is NOT in the framework targets themselves.

The Standard scheme's ThesisApp build uses MERGED_BINARY_TYPE=manual + MERGE_LINKED_LIBRARIES=YES, which merges some frameworks into the app binary. This merge process:
1. Takes the framework's .o files
2. Links them directly into the ThesisApp binary
3. **Removes the dylib from the framework bundle** (since it's now in the app)

The empty Zotero.framework and DocX.framework in DerivedData/Build/Products/Debug/ are artifacts of the Standard scheme build's merge step. When the preview host scheme builds, it reuses these cached empty frameworks instead of rebuilding them as standalone dylibs.

**Fix**: Delete empty framework bundles from Build/Products before building the preview host, forcing the build system to regenerate them. With MERGED_BINARY_TYPE=none on the preview host, the frameworks should be rebuilt as standalone dylibs.


## Session 5 Findings (2026-02-16): Testing build-review Config

### Attempt 20: Debug + ENABLE_DEBUG_DYLIB=NO + MERGED_BINARY_TYPE=none + wholemodule

Build args applied:
- `ENABLE_DEBUG_DYLIB=NO`
- `MERGED_BINARY_TYPE=none`
- `SKIP_MERGEABLE_LIBRARY_BUNDLE_HOOK=YES`
- `SWIFT_COMPILATION_MODE=wholemodule`
- `SWIFT_OPTIMIZATION_LEVEL=-Onone`
- Removed `MAKE_MERGEABLE=YES`

**Result**: Build failed before reaching the preview host target. Two failures:

1. **ASTMangler infinite recursion crash** (swift-frontend, 511 frames, stack overflow). `appendClosureComponents` → `appendType` → `appendFunctionType` → `appendClosureComponents` repeating. This is the same crash from attempt #1. The preview body from `Path+roundedTriangle.swift` contains nested struct/closure types that trigger the mangler bug when compiled as the preview host source.

2. **SPM transitive dependency linker errors** (pre-existing). Undefined symbols for HTTPTypes and ZIPFoundation — these are static .o libraries linked into framework targets, but the preview host can't find them.

### Analysis

The `ENABLE_DEBUG_DYLIB=NO` and `MERGED_BINARY_TYPE=none` settings are correct fixes for the .debug.dylib and empty framework issues. But they can't be verified because:
- The ASTMangler crash blocks compilation of the preview host itself
- The SPM linker errors block linking even if compilation succeeded

### Next steps

- [x] Fix ASTMangler crash — moved preview body to top-level function, avoiding nested types inside struct→closure chain
- [ ] Fix SPM transitive dependency linking for static .o packages
- [ ] Consider testing with a simpler project that doesn't have deep dependency chains
